{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">แดชบอร์ด</h1>
</div>
<div class="row">
    <!-- ยอดขายรวม -->
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-primary" style="height: 100px;">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="card-title"><i class="bi bi-cash-stack me-2"></i>ยอดขายรวม</h6>
                <h5 class="card-text">฿{{ '{:,.2f}'.format(total_sales) }}</h5>
            </div>
        </div>
    </div>
    <!-- ยอดขายวันนี้ (Real-time) -->
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-success" style="height: 100px;">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="card-title"><i class="bi bi-clock me-2"></i>ยอดขายวันนี้</h6>
                <h5 class="card-text" id="today-sales">฿0.00</h5>
            </div>
        </div>
    </div>
    <!-- จำนวนสินค้าที่ขายไป -->
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-info" style="height: 100px;">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="card-title"><i class="bi bi-box-seam me-2"></i>สินค้าขายไป</h6>
                <h5 class="card-text" id="total-units-sold">0 ชิ้น</h5>
            </div>
        </div>
    </div>
    <!-- รอสลิป -->
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-warning" style="height: 100px;">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="card-title"><i class="bi bi-exclamation-circle me-2"></i>รอสลิป</h6>
                <h5 class="card-text">{{ pending_orders }}</h5>
            </div>
        </div>
    </div>
    <!-- สินค้าใกล้หมด -->
    <div class="col-md-3 mb-3">
        <div class="card text-white bg-danger" style="height: 100px;">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="card-title"><i class="bi bi-box-seam me-2"></i>สินค้าใกล้หมด</h6>
                <h5 class="card-text">{{ low_stock_products }}</h5>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <!-- กราฟยอดขายรายชั่วโมง (Real-time) -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-clock-history me-2"></i>ยอดขายรายชั่วโมง (วันนี้)</div>
            <div class="card-body">
                <canvas id="hourlySalesChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <!-- กราฟยอดขายรายเดือน (Historical) -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-graph-up me-2"></i>ยอดขายรายเดือน</div>
            <div class="card-body">
                <canvas id="monthlySalesChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <!-- กราฟสินค้าขายดี (แสดงจำนวนหน่วย) -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-pie-chart me-2"></i>สินค้าขายดี (จำนวนหน่วย)</div>
            <div class="card-body">
                <canvas id="topProductsChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <!-- คำสั่งซื้อล่าสุด -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-table me-2"></i>คำสั่งซื้อล่าสุด</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead><tr><th>รหัส</th><th>ลูกค้า</th><th>วันที่</th><th>ยอดรวม</th><th>สลิป</th><th></th></tr></thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.customer.name if order.customer else 'ไม่ระบุ' }}</td>
                                <td>{{ order.order_date.strftime('%d/%m/%Y %H:%M') if order.order_date else 'ไม่ระบุ' }}</td>
                                <td>฿{{ '{:,.2f}'.format(order.total_amount) if order.total_amount else '0.00' }}</td>
                                <td>
                                    {% if order.payment_slip %}
                                    <span class="badge bg-success">มีสลิป</span>
                                    {% else %}
                                    <span class="badge bg-warning">รอสลิป</span>
                                    {% endif %}
                                </td>
                                <td><a href="{{ url_for('view_order', id=order.id) }}" class="btn btn-sm btn-outline-primary">ดู</a></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-center">ยังไม่มีคำสั่งซื้อ</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load');
        alert('ไม่สามารถโหลด Chart.js ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต');
        return;
    }

    function updateDashboard() {
        fetch('{{ url_for('realtime_data') }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                // อัปเดตยอดขายวันนี้
                document.getElementById('today-sales').textContent = '฿' + data.today_sales.toLocaleString('th-TH', { minimumFractionDigits: 2 });
                // อัปเดตจำนวนสินค้าที่ขายไป
                document.getElementById('total-units-sold').textContent = data.total_units_sold + ' ชิ้น';

                // กราฟยอดขายรายชั่วโมง (Real-time)
                const hourlySalesCtx = document.getElementById('hourlySalesChart').getContext('2d');
                new Chart(hourlySalesCtx, {
                    type: 'line',
                    data: {
                        labels: data.hourly_sales.map(item => item.hour),
                        datasets: [{
                            label: 'ยอดขาย (บาท)',
                            data: data.hourly_sales.map(item => item.amount),
                            borderColor: 'rgba(40, 167, 69, 1)',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ยอดขาย (บาท)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ชั่วโมง'
                                }
                            }
                        }
                    }
                });

                // กราฟยอดขายรายเดือน (Historical)
                const monthlySalesCtx = document.getElementById('monthlySalesChart').getContext('2d');
                new Chart(monthlySalesCtx, {
                    type: 'line',
                    data: {
                        labels: data.monthly_sales.map(item => item.month),
                        datasets: [{
                            label: 'ยอดขาย (บาท)',
                            data: data.monthly_sales.map(item => item.amount),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ยอดขาย (บาท)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'เดือน'
                                }
                            }
                        }
                    }
                });

                // กราฟสินค้าขายดี (แสดงจำนวนหน่วย)
                const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
                new Chart(topProductsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.top_products.map(item => item.name),
                        datasets: [{
                            label: 'จำนวนหน่วย',
                            data: data.top_products.map(item => item.quantity),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.5)',
                                'rgba(54, 162, 235, 0.5)',
                                'rgba(255, 206, 86, 0.5)',
                                'rgba(75, 192, 192, 0.5)',
                                'rgba(153, 102, 255, 0.5)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'สินค้าขายดี (จำนวนหน่วย)',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
                alert('ไม่สามารถโหลดข้อมูลกราฟได้: ' + error.message);
            });
    }

    updateDashboard();
    setInterval(updateDashboard, 30000);
});
</script>
{% endblock %}